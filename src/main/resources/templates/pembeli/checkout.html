<!DOCTYPE html>
<html lang="id" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Bukti Pembayaran | UBeli</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/checkout.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* CSS Tambahan untuk Area Upload */
        .upload-area {
            border: 2px dashed #3B5998;
            padding: 25px;
            text-align: center;
            border-radius: 12px;
            background: #f8f9fa;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
        }
        .upload-area:hover { background: #eef2ff; border-color: #2c4275; }
        .upload-text { color: #555; margin-top: 10px; font-size: 14px; }
        #preview-container { margin-top: 15px; display: none; }
        #preview-img { max-width: 100%; border-radius: 8px; border: 1px solid #ddd; }

        /* CSS untuk Pilihan Metode Pembayaran */
        .method-card {
            cursor: pointer;
            border: 1px solid #eee;
            transition: 0.2s;
            display: flex;
            align-items: center;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            gap: 15px;
        }
        .method-card:hover { border-color: #3B5998; background: #f8f9fa; }
        .method-card.active {
            border-color: #3B5998;
            background: #eef2ff;
        }
        .method-check { display: none; color: #3B5998; font-weight: bold; font-size: 18px; margin-left: auto; }
        .method-card.active .method-check { display: block; }
        .method-icon { font-size: 24px; color: #555; width: 30px; text-align: center;}
        
        .btn-view-qris {
            background: #fff; border: 1px solid #3B5998; color: #3B5998;
            padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; margin-top: 5px;
        }
        .btn-view-qris:hover { background: #3B5998; color: white; }

        /* CSS Modal (Pop-up QRIS) */
        .modal {
            display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: #fff; padding: 20px; border-radius: 10px; text-align: center;
            max-width: 350px; width: 90%; position: relative;
        }
        .close-btn {
            position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #aaa;
        }
        .qr-image-full { width: 100%; max-width: 300px; margin-top: 10px; }
    </style>
</head>
<body>

    <div th:replace="fragments/navbar :: navbar"></div>

    <form th:action="@{/transaksi/bayar}" method="post" enctype="multipart/form-data">
        
        <input type="hidden" name="pesananId" th:value="${pesanan.pesananId}">
        
        <input type="hidden" id="selectedMethod" name="metodePembayaran" value="TRANSFER">

        <main class="container checkout-page">

            <section class="checkout-left">

                <div class="box item-box">
                    <h3 class="box-title">Item yang dipesan <span style="font-weight:400; font-size:14px; color:#888;">(ID: #<span th:text="${pesanan.pesananId}"></span>)</span></h3>

                    <div class="item-card" style="display: flex; align-items: center;"> <img th:if="${produk != null && not #lists.isEmpty(produk.listFoto)}" 
                        th:src="${produk.listFoto[0].urlFoto}" class="item-thumb"
                        style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;">
                   <div th:if="${produk == null or #lists.isEmpty(produk.listFoto)}" 
                        class="item-thumb" style="width: 80px; height: 80px; background: #3B5998; border-radius: 8px;"></div>
               
                   <div class="item-info" style="flex: 1; margin-left: 15px; display: flex; flex-direction: column; justify-content: center;">
                       
                       <h4 class="item-name" 
                           th:text="${produk != null ? produk.namaProduk : 'Produk'}"
                           style="margin: 0 0 5px 0; font-size: 16px;">
                           Nama Produk
                       </h4>
                       
                       <div class="item-meta" style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
               
                           <span class="qty" style="color: #666; font-size: 14px;">
                               Qty: <b style="color: #000;">1</b>
                           </span> 
                           
                           <span class="price" style="color:#E74C3C; font-weight: bold; font-size: 16px;" 
                                 th:text="'Rp' + ${#numbers.formatDecimal(pesanan.totalHarga, 0, 'COMMA', 0, 'POINT')}">
                                 Rp 0
                           </span>
                       
                       </div>
                   </div>
               </div>
                </div>

                <div class="box">
                    <h3 class="box-title" style="color:#3B5998;">Konfirmasi Pembayaran</h3>
                    
                    <div id="info-transfer" class="alert-safe" style="background:#e3f2fd; border-left: 4px solid #2196f3; margin-bottom:15px;">
                        <strong>Silakan Transfer ke:</strong>
                        <p style="margin:5px 0 0 0;">BCA: <strong>123-456-7890</strong> (a.n UBeli Official)</p>
                    </div>

                    <div id="info-qris" class="alert-safe" style="display: none; background:#fff3cd; border-left: 4px solid #ffc107; margin-bottom:15px;">
                        <strong>Bayar via QRIS</strong>
                        <p style="margin:5px 0 5px 0;">Scan QRIS menggunakan GoPay, OVO, Dana, atau Mobile Banking.</p>
                        <button type="button" class="btn-view-qris" onclick="openQrisModal()">
                            <i class="fas fa-qrcode"></i> Tampilkan QR Code
                        </button>
                    </div>

                    <div class="upload-area" onclick="document.getElementById('fileBukti').click()">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 32px; color: #3B5998;"></i>
                        <p class="upload-text">Klik di sini untuk upload bukti transfer (JPG/PNG)</p>
                        <input type="file" id="fileBukti" name="fileBukti" accept="image/*" hidden required onchange="previewImage(this)">
                    </div>

                    <div id="preview-container">
                        <p style="font-size:12px; color:#666; margin-bottom:5px;">Preview Bukti:</p>
                        <img id="preview-img">
                    </div>
                </div>
            </section>


            <section class="checkout-right">

                <div class="box">
                    <h3 class="box-title">Rincian Pembayaran</h3>
                    <div class="payment-row">
                        <span>Total Tagihan</span>
                        <span class="val" th:text="'Rp' + ${#numbers.formatDecimal(pesanan.totalHarga, 0, 'COMMA', 0, 'POINT')}">Rp 0</span>
                    </div>
                    <div class="payment-total">
                        <span>Total Bayar</span>
                        <span class="val total" style="color:#E74C3C;" th:text="'Rp' + ${#numbers.formatDecimal(pesanan.totalHarga, 0, 'COMMA', 0, 'POINT')}">Rp 0</span>
                    </div>
                </div>

                <div class="box">
                    <h3 class="box-title">Metode Pembayaran</h3>
                    
                    <div class="method-card active" id="card-transfer" onclick="selectMethod('TRANSFER')">
                        <div class="method-icon"><i class="fas fa-university"></i></div>
                        <div>
                            <strong>Transfer Bank</strong>
                            <p style="font-size:12px; margin:0; color:#666;">Manual Check (BCA)</p>
                        </div>
                        <div class="method-check"><i class="fas fa-check-circle"></i></div>
                    </div>

                    <div class="method-card" id="card-qris" onclick="selectMethod('QRIS')">
                        <div class="method-icon"><i class="fas fa-qrcode"></i></div>
                        <div>
                            <strong>QRIS</strong>
                            <p style="font-size:12px; margin:0; color:#666;">E-Wallet & M-Banking</p>
                        </div>
                        <div class="method-check"><i class="fas fa-check-circle"></i></div>
                    </div>

                </div>

                <div class="alert-safe">
                    <strong>Transaksi Aman</strong>
                    <p>Bukti pembayaran Anda akan diverifikasi oleh Admin.</p>
                </div>

                <form th:action="@{/transaksi/bayar}" method="post" enctype="multipart/form-data">

                    <div class="btn-row">
                        <a href="/riwayat-pesanan" class="btn-light" style="text-align:center; padding-top:12px;">Batal</a>
                        
                        <button type="submit" class="btn-primary">Kirim Bukti Pembayaran</button>
                    </div>
                
                </form>

            </section>

        </main>
    </form>

    <div id="qrisModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeQrisModal()">&times;</span>
            <h3>Scan QRIS</h3>
            <p>UBeli Official Store</p>
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/d0/QR_code_for_mobile_English_Wikipedia.svg/1200px-QR_code_for_mobile_English_Wikipedia.svg.png" 
                 alt="QRIS Code" class="qr-image-full">
            <p style="font-size:12px; margin-top:10px; color:#888;">Total: <strong th:text="'Rp' + ${#numbers.formatDecimal(pesanan.totalHarga, 0, 'COMMA', 0, 'POINT')}"></strong></p>
        </div>
    </div>

    <script>
        // Logic Preview Gambar Bukti
        function previewImage(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('preview-img').src = e.target.result;
                    document.getElementById('preview-container').style.display = 'block';
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Logic Ganti Metode Pembayaran
        function selectMethod(method) {
            // Reset Class Active
            document.getElementById('card-transfer').classList.remove('active');
            document.getElementById('card-qris').classList.remove('active');

            // Hide Info
            document.getElementById('info-transfer').style.display = 'none';
            document.getElementById('info-qris').style.display = 'none';

            // Set Value Hidden Input
            document.getElementById('selectedMethod').value = method;

            if (method === 'TRANSFER') {
                document.getElementById('card-transfer').classList.add('active');
                document.getElementById('info-transfer').style.display = 'block';
            } else if (method === 'QRIS') {
                document.getElementById('card-qris').classList.add('active');
                document.getElementById('info-qris').style.display = 'block';
            }
        }

        // Logic Modal QRIS
        function openQrisModal() {
            document.getElementById('qrisModal').style.display = 'flex';
        }
        function closeQrisModal() {
            document.getElementById('qrisModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            var modal = document.getElementById('qrisModal');
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    </script>

</body>
</html>